✓ mustafar_package_quant 导入成功
依赖导入完成

=== 模型参数 ===
batch_size: 2
num_heads: 4
num_key_value_heads: 4
head_dim: 128
seq_len (compressed): 256
total_batch_kv: 8
total_batch_size: 8
num_key_value_groups: 1
量化位宽: 2 bits
每字节容纳量化值数: 16

K Cache 形状: torch.Size([8, 256, 128])
非零元素比例: 29.69%
数据类型: torch.float16

调用 convert_key_batched_quant...
k_bitmaps 形状: torch.Size([8, 512])
k_tile_offsets 形状: torch.Size([8, 512])
k_packed_quant 形状: torch.Size([7165])
k_scales 形状: torch.Size([8, 512])
k_zeros 形状: torch.Size([8, 512])

压缩后内存占用:
原始: 0.50 MB
压缩后: 0.11 MB
压缩比: 21.09%

Query 形状: torch.Size([2, 4, 1, 128])
Padded Query 形状: torch.Size([8, 8, 128])
Query 数据类型: torch.float16

调用 mustafar_package_quant.mustafar_key_formulation_quant...
✓ 调用成功
输出形状: torch.Size([8, 8, 256])
输出数据类型: torch.float16
输出统计:
  最大值: 26.671875
  最小值: -22.859375
  平均值: 0.021805
  标准差: 2.291016

测试普通密集矩阵乘法（Ground Truth）...
密集矩阵乘法输出形状: torch.Size([8, 8, 256])
密集矩阵乘法输出统计:
  最大值: 26.546875
  最小值: -26.828125
  平均值: 0.028259
  标准差: 2.146484

测试量化稀疏 Python 参考实现...
量化稀疏参考实现输出形状: torch.Size([8, 8, 256])
量化稀疏参考实现输出统计:
  最大值: 25.109375
  最小值: -22.296875
  平均值: 0.021591
  标准差: 2.332031

============================================================
对比分析
============================================================

【1】CUDA 量化实现 vs 量化稀疏参考实现
CUDA 结果样本 (前5个值): tensor([ 6.6172, -8.6250,  5.5742,  1.9893, -1.3975], device='cuda:0',
       dtype=torch.float16)
量化参考样本 (前5个值): tensor([ 2.9453, -0.9844, -6.8477,  4.1680,  1.4502], device='cuda:0',
       dtype=torch.float16)
差异统计:
  最大差异: 32.875000
  平均差异: 7.357891
  中位数差异: 6.125000
相对误差:
  最大相对误差: 62698.21%
  平均相对误差: 497.41%
是否接近 (rtol=5e-2, atol=5e-2): False

============================================================
【2】CUDA 量化实现 vs 密集矩阵乘法（Ground Truth）
CUDA 结果样本 (前5个值): tensor([ 6.6172, -8.6250,  5.5742,  1.9893, -1.3975], device='cuda:0',
       dtype=torch.float16)
密集矩阵样本 (前5个值): tensor([ 3.2324, -4.1094,  3.8105,  3.9355, -3.3164], device='cuda:0',
       dtype=torch.float16)
差异统计:
  最大差异: 8.695312
  平均差异: 1.734860
  中位数差异: 1.437500
相对误差:
  最大相对误差: 214751.46%
  平均相对误差: 285.74%
是否接近 (rtol=5e-2, atol=5e-2): False

============================================================
【3】量化稀疏参考实现 vs 密集矩阵乘法（Ground Truth）
量化参考样本 (前5个值): tensor([ 2.9453, -0.9844, -6.8477,  4.1680,  1.4502], device='cuda:0',
       dtype=torch.float16)
密集矩阵样本 (前5个值): tensor([ 3.2324, -4.1094,  3.8105,  3.9355, -3.3164], device='cuda:0',
       dtype=torch.float16)
差异统计 (量化误差 + 稀疏误差):
  最大差异: 32.617188
  平均差异: 7.101144
  中位数差异: 6.039185
相对误差:
  最大相对误差: 355211.96%
  平均相对误差: 830.40%
============================================================

性能测试...

性能对比 (10 次迭代):
  CUDA 量化实现:      0.0409 ms
  量化稀疏参考实现:   5647.7365 ms
  密集矩阵乘法:       0.3249 ms

加速比:
  CUDA vs 量化参考:   138204.92x
  CUDA vs 密集矩阵:   7.95x
  密集矩阵 vs 量化参考: 17380.82x

============================================================
测试总结
============================================================

模型配置:
  Batch size: 2
  Num heads: 4
  Head dim: 128
  Compressed seq len: 256
  Sparsity: 70.0%
  量化位宽: 2 bits

压缩效果:
  原始内存: 0.50 MB
  压缩后内存: 0.11 MB
  压缩比: 21.09%

功能验证:
  ✓ mustafar_key_formulation_quant 调用成功
  ✓ 输出形状正确: torch.Size([8, 8, 256])
  ⚠ CUDA 实现与量化参考实现有差异
  ⚠ CUDA 实现与密集矩阵乘法有差异（预期有量化+稀疏误差）

✓ 测试完成
============================================================
(mustar) zh@nku-PowerEdge-R750:~/mustafar/kernel_quant$ 